<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kana Practice - Shutokun</title>
    <base href="./">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>

    </script>
    <style>
        .practice-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            text-align: center;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mode-button {
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .mode-button:hover {
            background-color: #45a049;
        }

        .mode-button.active {
            background-color: #357abd;
        }

        .kana-display {
            font-size: 120px;
            margin: 2rem 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .kana-display.correct {
            transform: scale(1.1);
            color: #4CAF50;
        }

        .kana-display.incorrect {
            transform: scale(0.9);
            color: #f44336;
        }

        .input-container {
            margin: 2rem 0;
        }

        .answer-input {
            font-size: 1.5rem;
            padding: 1rem;
            width: 200px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .feedback {
            font-size: 1.2rem;
            margin: 1rem 0;
            min-height: 2rem;
            transition: opacity 0.3s;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
@media (max-width: 600px) {
  .stats-container {
    flex-direction: row !important;
    align-items: stretch;
    font-size: 1rem;
    padding: 0.5rem !important;
    border-radius: 6px !important;
    margin-bottom: 1rem !important;
    gap: 0.5rem;
  }
  .review-status > div {
    font-size: 1rem;
    padding: 0.5rem 0.25rem;
    flex: 1 1 0;
    min-width: 0;
  }
  .review-status span {
    font-size: 1.2rem !important;
  }
}
        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .keyboard-hints {
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 600px) {
            .kana-display {
                font-size: 80px;
            }

            .answer-input {
                width: 150px;
                font-size: 1.2rem;
            }

            .stats-container {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Loading and Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            display: none;
        }

        .sync-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
        }

        .sync-status.syncing {
            background: #fff3e0;
            color: #ef6c00;
        }

        .sync-status.synced {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sync-status.error {
            background: #ffebee;
            color: #c62828;
        }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ: body[data-theme="dark"] ã§å…¨ä½“ã®é…è‰²ã‚’èª¿æ•´ */
    body[data-theme="dark"], body.dark-mode {
      background-color: #181a20 !important;
      color: #f1f1f1 !important;
    }
    body[data-theme="dark"] header,
    body.dark-mode header {
      background-color: #23262e !important;
      color: #f1f1f1 !important;
      border-bottom: 1px solid #333a4d !important;
    }
    body[data-theme="dark"] .card,
    body.dark-mode .card {
      background: #23262e !important;
      color: #f1f1f1 !important;
    }
    body[data-theme="dark"] .nav-menu,
    body.dark-mode .nav-menu {
      background: #23262e !important;
      color: #f1f1f1 !important;
      border-bottom: 1px solid #333a4d !important;
    }
    body[data-theme="dark"] .auth-button,
    body.dark-mode .auth-button {
      background: #23262e !important;
      color: #f1f1f1 !important;
      border: 1px solid #4fc3f7 !important;
    }
    body[data-theme="dark"] .auth-button:hover,
    body.dark-mode .auth-button:hover {
      background: #4fc3f7 !important;
      color: #23262e !important;
    }
    body[data-theme="dark"] .logo,
    body.dark-mode .logo {
      filter: brightness(0.9) invert(0.85) !important;
    }
    body[data-theme="dark"] .keyboard-shortcuts,
    body.dark-mode .keyboard-shortcuts {
      background: rgba(30, 34, 45, 0.95) !important;
      color: #f1f1f1 !important;
    }
    /* å¿…è¦ã«å¿œã˜ã¦ä»–ã®è¦ç´ ã‚‚è¿½åŠ  */
    </style>
    <!-- ...æ—¢å­˜ã®headå†…ã‚³ãƒ¼ãƒ‰... -->
    <script>
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ—¢å­˜ã®ã‚‚ã®ãŒãªã‘ã‚Œã°è¿½åŠ ï¼‰
    function loadTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      const toggle = document.getElementById('theme-toggle');
      if (toggle) toggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      const toggle = document.getElementById('theme-toggle');
      if (toggle) toggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    document.addEventListener('DOMContentLoaded', function() {
      loadTheme();
      const toggle = document.getElementById('theme-toggle');
      if (toggle) toggle.addEventListener('click', toggleTheme);
    });
    </script>
    <!-- ...æ—¢å­˜ã®headå†…ã‚³ãƒ¼ãƒ‰... -->
</head>
<body>
    <header>
        <div class="header-left">
            <button class="hamburger-menu" id="hamburger-menu" type="button">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <img src="assets/logo.png" alt="Shutokun logo" class="logo">
        </div>
        <div class="auth-container">
            <button id="loginBtn" class="auth-button" type="button">Sign in with Google</button>
            <button id="logoutBtn" class="auth-button" style="display: none;" type="button">Sign out</button>
        </div>
    </header>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<nav class="nav-menu" id="nav-menu">
    <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="how-to-use.html">How To Use</a></li>
    <li><a href="about.html">About Us</a></li>
    <li>
        <button id="clear-cache-btn" style="width:100%;background:none;border:none;color:#c00;cursor:pointer;margin-bottom: 10px;">
            Clear Cache
        </button>
    </li>
    <li>
        <button id="resetAllProgressBtn" style="width:100%;text-align:center;background:none;border:none;color:#c00;cursor:pointer;margin-bottom: 10px;">
            Reset Progress
        </button>
    </li>
    </ul>
</nav>
<!--
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
-->
    <div class="error-message" id="error-message"></div>
    <div class="sync-status" id="sync-status"></div>

    <main class="practice-container">
        <div class="mode-selector">
            <button class="mode-button active" onclick="setMode('hiragana', event)" type="button">Hiragana</button>
            <button class="mode-button" onclick="setMode('katakana', event)" type="button">Katakana</button>
            <button class="mode-button" onclick="setMode('mixed', event)" type="button">Mixed</button>
        </div>

        <div class="practice-settings" style="margin: 1rem 0; display: flex; gap: 1rem; justify-content: center;">
            <div class="setting-group">
                <label>Practice Mode:</label>
                <select id="practice-mode" onchange="updatePracticeSettings()">
                    <option value="reading">Reading (Kana â†’ Romaji)</option>
                    <option value="writing">Writing (Romaji â†’ Kana)</option>
                    <option value="mixed">Mixed</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Difficulty:</label>
                <select id="difficulty" onchange="updatePracticeSettings()">
                    <option value="basic">Basic</option>
                    <option value="dakuten">With Dakuten</option>
                    <option value="all">All Kana</option>
                </select>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="incorrect-count">0</div>
                <div class="stat-label">Incorrect</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Streak</div>
            </div>
        </div>

        <div class="kana-display" id="kana-display">ã‚</div>

        <div class="input-container">
            <input type="text" id="answer" class="answer-input" placeholder="Type romaji..." autocomplete="off">
            <div class="feedback" id="feedback"></div>
            <div class="keyboard-hints">
                Enterã‚­ãƒ¼ã§é€ä¿¡ã€Spaceã§æ¬¡ã®ã‹ãª<br>
                1-3ã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠ/ãƒŸãƒƒã‚¯ã‚¹ï¼‰<br>
                R/W/Mã‚­ãƒ¼ã§ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°/ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°/ãƒŸãƒƒã‚¯ã‚¹ï¼‰
            </div>
        </div>

        <div class="progress-container" style="margin-top: 2rem; display: none;">
            <h3>Progress by Kana</h3>
            <div id="kana-progress" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
        </div>

        <div id="session-summary" class="session-summary" style="display: none; margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Session Summary</h3>
            <div id="summary-content"></div>
            <button onclick="startNewSession()" class="mode-button" style="margin-top: 1rem;">Start New Session</button>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="navigation-container">
            <button class="nav-button" onclick="window.location.href='index.html'">Back to Home</button>
            <button class="nav-button reset-all-progress" id="resetAllProgressBtn" style="background:#e74c3c;color:white;">Reset All Progress</button>
            <button class="nav-button" onclick="window.location.href='level-select.html'">Change Level</button>
        </div>
    </main>

    <script>
        // ã‹ãªãƒ‡ãƒ¼ã‚¿å®šç¾©
        const kanaData = {
            hiragana: [
                // Basic vowels
                { kana: 'ã‚', romaji: 'a' }, { kana: 'ã„', romaji: 'i' }, { kana: 'ã†', romaji: 'u' },
                { kana: 'ãˆ', romaji: 'e' }, { kana: 'ãŠ', romaji: 'o' },
                // K series
                { kana: 'ã‹', romaji: 'ka' }, { kana: 'ã', romaji: 'ki' }, { kana: 'ã', romaji: 'ku' },
                { kana: 'ã‘', romaji: 'ke' }, { kana: 'ã“', romaji: 'ko' },
                // S series
                { kana: 'ã•', romaji: 'sa' }, { kana: 'ã—', romaji: 'shi' }, { kana: 'ã™', romaji: 'su' },
                { kana: 'ã›', romaji: 'se' }, { kana: 'ã', romaji: 'so' },
                // T series
                { kana: 'ãŸ', romaji: 'ta' }, { kana: 'ã¡', romaji: 'chi' }, { kana: 'ã¤', romaji: 'tsu' },
                { kana: 'ã¦', romaji: 'te' }, { kana: 'ã¨', romaji: 'to' },
                // N series
                { kana: 'ãª', romaji: 'na' }, { kana: 'ã«', romaji: 'ni' }, { kana: 'ã¬', romaji: 'nu' },
                { kana: 'ã­', romaji: 'ne' }, { kana: 'ã®', romaji: 'no' },
                // H series
                { kana: 'ã¯', romaji: 'ha' }, { kana: 'ã²', romaji: 'hi' }, { kana: 'ãµ', romaji: 'fu' },
                { kana: 'ã¸', romaji: 'he' }, { kana: 'ã»', romaji: 'ho' },
                // M series
                { kana: 'ã¾', romaji: 'ma' }, { kana: 'ã¿', romaji: 'mi' }, { kana: 'ã‚€', romaji: 'mu' },
                { kana: 'ã‚', romaji: 'me' }, { kana: 'ã‚‚', romaji: 'mo' },
                // Y series
                { kana: 'ã‚„', romaji: 'ya' }, { kana: 'ã‚†', romaji: 'yu' }, { kana: 'ã‚ˆ', romaji: 'yo' },
                // R series
                { kana: 'ã‚‰', romaji: 'ra' }, { kana: 'ã‚Š', romaji: 'ri' }, { kana: 'ã‚‹', romaji: 'ru' },
                { kana: 'ã‚Œ', romaji: 're' }, { kana: 'ã‚', romaji: 'ro' },
                // W series
                { kana: 'ã‚', romaji: 'wa' }, { kana: 'ã‚’', romaji: 'wo' },
                // N
                { kana: 'ã‚“', romaji: 'n' },
                // Dakuten
                { kana: 'ãŒ', romaji: 'ga' }, { kana: 'ã', romaji: 'gi' }, { kana: 'ã', romaji: 'gu' },
                { kana: 'ã’', romaji: 'ge' }, { kana: 'ã”', romaji: 'go' },
                { kana: 'ã–', romaji: 'za' }, { kana: 'ã˜', romaji: 'ji' }, { kana: 'ãš', romaji: 'zu' },
                { kana: 'ãœ', romaji: 'ze' }, { kana: 'ã', romaji: 'zo' },
                { kana: 'ã ', romaji: 'da' }, { kana: 'ã¢', romaji: 'ji' }, { kana: 'ã¥', romaji: 'zu' },
                { kana: 'ã§', romaji: 'de' }, { kana: 'ã©', romaji: 'do' },
                { kana: 'ã°', romaji: 'ba' }, { kana: 'ã³', romaji: 'bi' }, { kana: 'ã¶', romaji: 'bu' },
                { kana: 'ã¹', romaji: 'be' }, { kana: 'ã¼', romaji: 'bo' },
                // Handakuten
                { kana: 'ã±', romaji: 'pa' }, { kana: 'ã´', romaji: 'pi' }, { kana: 'ã·', romaji: 'pu' },
                { kana: 'ãº', romaji: 'pe' }, { kana: 'ã½', romaji: 'po' },
                // Small kana
                { kana: 'ã', romaji: 'a' }, { kana: 'ãƒ', romaji: 'i' }, { kana: 'ã…', romaji: 'u' },
                { kana: 'ã‡', romaji: 'e' }, { kana: 'ã‰', romaji: 'o' },
                { kana: 'ã£', romaji: 'tsu' },
                { kana: 'ã‚ƒ', romaji: 'ya' }, { kana: 'ã‚…', romaji: 'yu' }, { kana: 'ã‚‡', romaji: 'yo' }
            ],
            katakana: [
                // Basic vowels
                { kana: 'ã‚¢', romaji: 'a' }, { kana: 'ã‚¤', romaji: 'i' }, { kana: 'ã‚¦', romaji: 'u' },
                { kana: 'ã‚¨', romaji: 'e' }, { kana: 'ã‚ª', romaji: 'o' },
                // K series
                { kana: 'ã‚«', romaji: 'ka' }, { kana: 'ã‚­', romaji: 'ki' }, { kana: 'ã‚¯', romaji: 'ku' },
                { kana: 'ã‚±', romaji: 'ke' }, { kana: 'ã‚³', romaji: 'ko' },
                // S series
                { kana: 'ã‚µ', romaji: 'sa' }, { kana: 'ã‚·', romaji: 'shi' }, { kana: 'ã‚¹', romaji: 'su' },
                { kana: 'ã‚»', romaji: 'se' }, { kana: 'ã‚½', romaji: 'so' },
                // T series
                { kana: 'ã‚¿', romaji: 'ta' }, { kana: 'ãƒ', romaji: 'chi' }, { kana: 'ãƒ„', romaji: 'tsu' },
                { kana: 'ãƒ†', romaji: 'te' }, { kana: 'ãƒˆ', romaji: 'to' },
                // N series
                { kana: 'ãƒŠ', romaji: 'na' }, { kana: 'ãƒ‹', romaji: 'ni' }, { kana: 'ãƒŒ', romaji: 'nu' },
                { kana: 'ãƒ', romaji: 'ne' }, { kana: 'ãƒ', romaji: 'no' },
                // H series
                { kana: 'ãƒ', romaji: 'ha' }, { kana: 'ãƒ’', romaji: 'hi' }, { kana: 'ãƒ•', romaji: 'fu' },
                { kana: 'ãƒ˜', romaji: 'he' }, { kana: 'ãƒ›', romaji: 'ho' },
                // M series
                { kana: 'ãƒ', romaji: 'ma' }, { kana: 'ãƒŸ', romaji: 'mi' }, { kana: 'ãƒ ', romaji: 'mu' },
                { kana: 'ãƒ¡', romaji: 'me' }, { kana: 'ãƒ¢', romaji: 'mo' },
                // Y series
                { kana: 'ãƒ¤', romaji: 'ya' }, { kana: 'ãƒ¦', romaji: 'yu' }, { kana: 'ãƒ¨', romaji: 'yo' },
                // R series
                { kana: 'ãƒ©', romaji: 'ra' }, { kana: 'ãƒª', romaji: 'ri' }, { kana: 'ãƒ«', romaji: 'ru' },
                { kana: 'ãƒ¬', romaji: 're' }, { kana: 'ãƒ­', romaji: 'ro' },
                // W series
                { kana: 'ãƒ¯', romaji: 'wa' }, { kana: 'ãƒ²', romaji: 'wo' },
                // N
                { kana: 'ãƒ³', romaji: 'n' },
                // Dakuten
                { kana: 'ã‚¬', romaji: 'ga' }, { kana: 'ã‚®', romaji: 'gi' }, { kana: 'ã‚°', romaji: 'gu' },
                { kana: 'ã‚²', romaji: 'ge' }, { kana: 'ã‚´', romaji: 'go' },
                { kana: 'ã‚¶', romaji: 'za' }, { kana: 'ã‚¸', romaji: 'ji' }, { kana: 'ã‚º', romaji: 'zu' },
                { kana: 'ã‚¼', romaji: 'ze' }, { kana: 'ã‚¾', romaji: 'zo' },
                { kana: 'ãƒ€', romaji: 'da' }, { kana: 'ãƒ‚', romaji: 'ji' }, { kana: 'ãƒ…', romaji: 'zu' },
                { kana: 'ãƒ‡', romaji: 'de' }, { kana: 'ãƒ‰', romaji: 'do' },
                { kana: 'ãƒ', romaji: 'ba' }, { kana: 'ãƒ“', romaji: 'bi' }, { kana: 'ãƒ–', romaji: 'bu' },
                { kana: 'ãƒ™', romaji: 'be' }, { kana: 'ãƒœ', romaji: 'bo' },
                // Handakuten
                { kana: 'ãƒ‘', romaji: 'pa' }, { kana: 'ãƒ”', romaji: 'pi' }, { kana: 'ãƒ—', romaji: 'pu' },
                { kana: 'ãƒš', romaji: 'pe' }, { kana: 'ãƒ', romaji: 'po' },
                // Small kana
                { kana: 'ã‚¡', romaji: 'a' }, { kana: 'ã‚£', romaji: 'i' }, { kana: 'ã‚¥', romaji: 'u' },
                { kana: 'ã‚§', romaji: 'e' }, { kana: 'ã‚©', romaji: 'o' },
                { kana: 'ãƒƒ', romaji: 'tsu' },
                { kana: 'ãƒ£', romaji: 'ya' }, { kana: 'ãƒ¥', romaji: 'yu' }, { kana: 'ãƒ§', romaji: 'yo' }
            ]
        };

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyB8D99bt_z2FtMeRDY-gdDYFMqqceZV_2s",
            authDomain: "shutokun.firebaseapp.com",
            projectId: "shutokun",
            storageBucket: "shutokun.appspot.com",
            messagingSenderId: "120770573657",
            appId: "1:120770573657:web:692c54b821b0a51c138848",
            measurementId: "G-GJG5NT05DH"
        };

        // FirebaseåˆæœŸåŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            firebase.analytics(); // AnalyticsåˆæœŸåŒ–
        }

        let currentUser = null;
        let currentMode = 'hiragana';
        let currentKana = {};
        let practiceMode = 'reading';
        let difficulty = 'basic';
        let sessionStartTime = Date.now();
        let sessionStats = {
            correct: 0,
            incorrect: 0,
            timeSpent: 0,
            kanaAttempted: new Set()
        };
        let stats = {
            correct: 0,
            incorrect: 0,
            streak: 0,
            get accuracy() {
                const total = this.correct + this.incorrect;
                return total === 0 ? 0 : Math.round((this.correct / total) * 100);
            }
        };

        // Kana progress tracking
        let kanaProgress = {};

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                await loadProgress();
            } else {
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'none';
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
                loadFromLocalStorage();
            }
        });

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: debounceé–¢æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: throttleé–¢æ•°
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func(...args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function showError(message, duration = 5000) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, duration);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // åŒæœŸçŠ¶æ…‹ç®¡ç†
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('sync-status');
            syncElement.textContent = message;
            syncElement.className = `sync-status ${status}`;
            syncElement.style.display = 'block';
            setTimeout(() => {
                syncElement.style.display = 'none';
            }, 3000);
        }

        // é€²æ—ä¿å­˜ã®æœ€é©åŒ–ï¼ˆdebounceï¼‰
        const debouncedSaveProgress = debounce(async () => {
            try {
                updateSyncStatus('syncing', 'Saving progress...');
                await saveProgress();
                updateSyncStatus('synced', 'Progress saved');
            } catch (error) {
                console.error('Error saving progress:', error);
                updateSyncStatus('error', 'Failed to save progress');
                showError('Failed to save progress. Changes will be saved locally.');
            }
        }, 1000);

        // çµ±è¨ˆæ›´æ–°ã®æœ€é©åŒ–ï¼ˆthrottleï¼‰
        const throttledUpdateStats = throttle(() => {
            updateStats();
            updateKanaProgress();
        }, 100);

        // kanaProgressã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§åˆæœŸåŒ–
        function initializeKanaProgress() {
            const allKana = [...kanaData.hiragana, ...kanaData.katakana];
            allKana.forEach(kana => {
                if (!kanaProgress[kana.kana]) {
                    kanaProgress[kana.kana] = { correct: 0, incorrect: 0 };
                }
            });
        }

        // é€²æ—èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–ã‚’å‘¼ã³å‡ºã—
        async function loadProgress() {
            if (!currentUser) return;

            showLoading();
            try {
                const progressRef = firebase.database().ref(`users/${currentUser.uid}/kana-progress`);
                const snapshot = await progressRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    kanaProgress = data.progress || {};
                    stats = data.stats || stats;
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆã®kanaAttemptedã‚‚å¾©å…ƒ
                    if (data.sessionStats && Array.isArray(data.sessionStats.kanaAttempted)) {
                        sessionStats.kanaAttempted = new Set(data.sessionStats.kanaAttempted);
                    }
                }
                initializeKanaProgress();
                throttledUpdateStats();
            } catch (error) {
                console.error("Error loading progress:", error);
                showError('Failed to load progress from server. Using local data.');
                loadFromLocalStorage();
            } finally {
                hideLoading();
            }
        }

        // localStorageæ“ä½œã®å¼·åŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        function loadFromLocalStorage() {
            try {
                const savedProgress = localStorage.getItem('kanaProgress');
                if (savedProgress) {
                    const data = JSON.parse(savedProgress);
                    kanaProgress = data.progress || {};
                    stats = data.stats || stats;
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆã®kanaAttemptedã‚‚å¾©å…ƒ
                    if (data.sessionStats && Array.isArray(data.sessionStats.kanaAttempted)) {
                        sessionStats.kanaAttempted = new Set(data.sessionStats.kanaAttempted);
                    }
                    initializeKanaProgress();
                    throttledUpdateStats();
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                showError('Failed to load local progress data.');
            }
        }

        // é€²æ—ä¿å­˜ã®å¼·åŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
        async function saveProgress() {
            const data = {
                progress: kanaProgress,
                stats: stats,
                lastModified: Date.now(),
                sessionStats: {
                    ...sessionStats,
                    kanaAttempted: Array.from(sessionStats.kanaAttempted) // Setâ†’é…åˆ—ã§ä¿å­˜
                }
            };

            if (currentUser) {
                let retryCount = 0;
                const maxRetries = 3;

                while (retryCount < maxRetries) {
                    try {
                        const progressRef = firebase.database().ref(`users/${currentUser.uid}/kana-progress`);
                        await progressRef.set(data);
                        return;
                    } catch (error) {
                        retryCount++;
                        if (retryCount === maxRetries) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    }
                }
            }

            // Fallback to localStorage
            try {
                localStorage.setItem('kanaProgress', JSON.stringify(data));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showError('Failed to save progress locally.');
            }
        }

        function updateKanaProgress() {
            const container = document.getElementById('kana-progress');
            container.innerHTML = '';

            Object.entries(kanaProgress).forEach(([kana, data]) => {
                const accuracy = data.correct + data.incorrect === 0 ? 0 :
                    Math.round((data.correct / (data.correct + data.incorrect)) * 100);

                const div = document.createElement('div');
                div.className = 'kana-progress-item';
                div.innerHTML = `
                    <div style="font-size: 1.5rem;">${kana}</div>
                    <div style="font-size: 0.9rem; color: #666;">
                        Correct: ${data.correct}<br>
                        Incorrect: ${data.incorrect}<br>
                        Accuracy: ${accuracy}%
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStats() {
            document.getElementById('correct-count').textContent = stats.correct;
            document.getElementById('incorrect-count').textContent = stats.incorrect;
            document.getElementById('accuracy').textContent = `${stats.accuracy}%`;
            document.getElementById('streak').textContent = stats.streak;
        }

        // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ã®ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£ç‰ˆ
        function getFilteredKanaList() {
            let list;
            if (currentMode === 'mixed') {
                const randomMode = Math.random() < 0.5 ? 'hiragana' : 'katakana';
                list = kanaData[randomMode];
            } else {
                list = kanaData[currentMode];
            }

            if (difficulty === 'basic') {
                // æ¸…éŸ³ï¼ˆæ¿ç‚¹ãƒ»åŠæ¿ç‚¹ãƒ»å°æ›¸ãæ–‡å­—ã‚’é™¤å¤–ï¼‰
                list = list.filter(k => k.kana.match(/^[\u3042-\u3093\u30A2-\u30F3]$/));
            } else if (difficulty === 'dakuten') {
                // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã®ã¿
                list = list.filter(k => k.kana.match(/^[ãŒ-ã½ã‚¬-ãƒã±-ã½ãƒ‘-ãƒ]$/));
            }
            // all: ã™ã¹ã¦
            return list;
        }

        // setModeã®eventæœªå®šç¾©æ™‚ã®å‡¦ç†
        function setMode(mode, event) {
            currentMode = mode;
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById('feedback').textContent = '';
            nextKana();
        }

        // nextKanaã§ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function nextKana() {
            const kanaDisplay = document.getElementById('kana-display');
            kanaDisplay.classList.remove('correct', 'incorrect');
            const list = getFilteredKanaList();
            if (!list || list.length === 0) {
                kanaDisplay.textContent = 'No kana for this setting.';
                document.getElementById('answer').placeholder = '';
                return;
            }
            currentKana = list[Math.floor(Math.random() * list.length)];
            if (practiceMode === 'writing') {
                kanaDisplay.textContent = currentKana.romaji;
                document.getElementById('answer').placeholder = 'Type kana...';
            } else {
                kanaDisplay.textContent = currentKana.kana;
                document.getElementById('answer').placeholder = 'Type romaji...';
            }
            const answerInput = document.getElementById('answer');
            answerInput.value = '';
            answerInput.focus();
        }

        function checkAnswer(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                const input = document.getElementById('answer').value.trim().toLowerCase();
                const feedback = document.getElementById('feedback');
                const kanaDisplay = document.getElementById('kana-display');
                
                try {
                    if (!currentKana || !currentKana.kana || !currentKana.romaji) {
                        throw new Error('Invalid kana data');
                    }

                    // Initialize progress for this kana if not exists
                    if (!kanaProgress[currentKana.kana]) {
                        kanaProgress[currentKana.kana] = { correct: 0, incorrect: 0 };
                    }
                    
                    const isCorrect = practiceMode === 'writing' ? 
                        input === currentKana.kana : 
                        input === currentKana.romaji;
                    
                    if (isCorrect) {
                        feedback.textContent = 'âœ… Correct!';
                        kanaDisplay.classList.add('correct');
                        stats.correct++;
                        stats.streak++;
                        kanaProgress[currentKana.kana].correct++;
                        sessionStats.correct++;
                    } else {
                        feedback.textContent = `âŒ Incorrect. The answer was "${practiceMode === 'writing' ? currentKana.kana : currentKana.romaji}"`;
                        kanaDisplay.classList.add('incorrect');
                        stats.incorrect++;
                        stats.streak = 0;
                        kanaProgress[currentKana.kana].incorrect++;
                        sessionStats.incorrect++;
                    }
                    
                    sessionStats.kanaAttempted.add(currentKana.kana);
                    sessionStats.timeSpent = Math.floor((Date.now() - sessionStartTime) / 1000);
                    
                    throttledUpdateStats();
                    debouncedSaveProgress();
                    
                    // Show session summary after 20 attempts or if there's an error
                    if (sessionStats.correct + sessionStats.incorrect >= 20) {
                        showSessionSummary();
                    } else {
                        setTimeout(nextKana, 1000);
                    }
                } catch (error) {
                    console.error('Error processing answer:', error);
                    showError('An error occurred while processing your answer. Please try again.');
                    setTimeout(nextKana, 1000);
                }
            }
        }

        function showSessionSummary() {
            const summary = document.getElementById('session-summary');
            const content = document.getElementById('summary-content');
            
            const accuracy = sessionStats.correct + sessionStats.incorrect === 0 ? 0 :
                Math.round((sessionStats.correct / (sessionStats.correct + sessionStats.incorrect)) * 100);
            
            const minutes = Math.floor(sessionStats.timeSpent / 60);
            const seconds = sessionStats.timeSpent % 60;
            
            content.innerHTML = `
                <p>Total Attempts: ${sessionStats.correct + sessionStats.incorrect}</p>
                <p>Correct: ${sessionStats.correct}</p>
                <p>Incorrect: ${sessionStats.incorrect}</p>
                <p>Accuracy: ${accuracy}%</p>
                <p>Time Spent: ${minutes}m ${seconds}s</p>
                <p>Unique Kana Practiced: ${sessionStats.kanaAttempted.size}</p>
            `;
            
            summary.style.display = 'block';
        }

        // startNewSessionã§Setã‚’æ­£ã—ãåˆæœŸåŒ–
        function startNewSession() {
            sessionStartTime = Date.now();
            sessionStats = {
                correct: 0,
                incorrect: 0,
                timeSpent: 0,
                kanaAttempted: new Set()
            };
            document.getElementById('session-summary').style.display = 'none';
            nextKana();
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (event) => {
            if (event.key >= '1' && event.key <= '3') {
                const modes = ['hiragana', 'katakana', 'mixed'];
                setMode(modes[parseInt(event.key) - 1]);
            } else if (event.key.toLowerCase() === 'r') {
                document.getElementById('practice-mode').value = 'reading';
                updatePracticeSettings();
            } else if (event.key.toLowerCase() === 'w') {
                document.getElementById('practice-mode').value = 'writing';
                updatePracticeSettings();
            } else if (event.key.toLowerCase() === 'm') {
                document.getElementById('practice-mode').value = 'mixed';
                updatePracticeSettings();
            }
        });

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('online', () => {
            updateSyncStatus('syncing', 'Back online, syncing...');
            debouncedSaveProgress();
        });

        window.addEventListener('offline', () => {
            updateSyncStatus('error', 'Offline mode - changes saved locally');
        });

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
    try {
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const navMenu = document.getElementById('nav-menu');
        let menuOverlay;

        if (hamburgerMenu && navMenu) {
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¦ç´ ä½œæˆ
            menuOverlay = document.createElement('div');
            menuOverlay.className = 'menu-overlay';
            document.body.appendChild(menuOverlay);

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒˆã‚°ãƒ«é–¢æ•°
            function toggleMenu() {
                hamburgerMenu.classList.toggle('active');
                navMenu.classList.toggle('active');
                menuOverlay.classList.toggle('active');
                document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            hamburgerMenu.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            const navLinks = navMenu.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (navMenu.classList.contains('active')) {
                        toggleMenu();
                    }
                });
            });
        }
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                document.getElementById('answer').addEventListener('keyup', checkAnswer);
                // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
                setMode('hiragana');
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
                if (navigator.onLine) {
                    updateSyncStatus('synced', 'Online');
                } else {
                    updateSyncStatus('error', 'Offline mode');
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Failed to initialize the app. Please refresh the page.');
            }
        });

        // å…¨é€²æ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        const resetAllBtn = document.getElementById('resetAllProgressBtn');
        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', () => {
                if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‹ãªé€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    // localStorageã¨Firebaseï¼ˆåˆ©ç”¨æ™‚ï¼‰ã®å…¨ã‹ãªé€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
                    localStorage.removeItem('kanaProgress');
                    // Firebaseä¿å­˜ãŒã‚ã‚Œã°ã“ã“ã§å‰Šé™¤å‡¦ç†ã‚’è¿½åŠ 
                    // ç”»é¢ãƒªãƒ­ãƒ¼ãƒ‰ã§åˆæœŸçŠ¶æ…‹ã«
                    location.reload();
                }
            });
        }
    </script>
    <script src="/firebase-db.js"></script>
    <script src="/script.js"></script>
</body>
</html>
