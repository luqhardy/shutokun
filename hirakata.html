<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kana Practice - Shutokun</title>
    <base href="./">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>

    </script>
    <style>
        .practice-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            text-align: center;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mode-button {
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .mode-button:hover {
            background-color: #45a049;
        }

        .mode-button.active {
            background-color: #357abd;
        }

        .kana-display {
            font-size: 120px;
            margin: 2rem 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .kana-display.correct {
            transform: scale(1.1);
            color: #4CAF50;
        }

        .kana-display.incorrect {
            transform: scale(0.9);
            color: #f44336;
        }

        .input-container {
            margin: 2rem 0;
        }

        .answer-input {
            font-size: 1.5rem;
            padding: 1rem;
            width: 200px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .feedback {
            font-size: 1.2rem;
            margin: 1rem 0;
            min-height: 2rem;
            transition: opacity 0.3s;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
@media (max-width: 600px) {
  .stats-container {
    flex-direction: row !important;
    align-items: stretch;
    font-size: 1rem;
    padding: 0.5rem !important;
    border-radius: 6px !important;
    margin-bottom: 1rem !important;
    gap: 0.5rem;
  }
  .review-status > div {
    font-size: 1rem;
    padding: 0.5rem 0.25rem;
    flex: 1 1 0;
    min-width: 0;
  }
  .review-status span {
    font-size: 1.2rem !important;
  }
}
        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .keyboard-hints {
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 600px) {
            .kana-display {
                font-size: 80px;
            }

            .answer-input {
                width: 150px;
                font-size: 1.2rem;
            }

            .stats-container {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Loading and Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            display: none;
        }

        .sync-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
        }

        .sync-status.syncing {
            background: #fff3e0;
            color: #ef6c00;
        }

        .sync-status.synced {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sync-status.error {
            background: #ffebee;
            color: #c62828;
        }

    /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú: body[data-theme="dark"] „ÅßÂÖ®‰Ωì„ÅÆÈÖçËâ≤„ÇíË™øÊï¥ */
    body[data-theme="dark"], body.dark-mode {
      background-color: #181a20 !important;
      color: #f1f1f1 !important;
    }
    body[data-theme="dark"] header,
    body.dark-mode header {
      background-color: #23262e !important;
      color: #f1f1f1 !important;
      border-bottom: 1px solid #333a4d !important;
    }
    body[data-theme="dark"] .card,
    body.dark-mode .card {
      background: #23262e !important;
      color: #f1f1f1 !important;
    }
    body[data-theme="dark"] .nav-menu,
    body.dark-mode .nav-menu {
      background: #23262e !important;
      color: #f1f1f1 !important;
      border-bottom: 1px solid #333a4d !important;
    }
    body[data-theme="dark"] .auth-button,
    body.dark-mode .auth-button {
      background: #23262e !important;
      color: #f1f1f1 !important;
      border: 1px solid #4fc3f7 !important;
    }
    body[data-theme="dark"] .auth-button:hover,
    body.dark-mode .auth-button:hover {
      background: #4fc3f7 !important;
      color: #23262e !important;
    }
    body[data-theme="dark"] .logo,
    body.dark-mode .logo {
      filter: brightness(0.9) invert(0.85) !important;
    }
    body[data-theme="dark"] .keyboard-shortcuts,
    body.dark-mode .keyboard-shortcuts {
      background: rgba(30, 34, 45, 0.95) !important;
      color: #f1f1f1 !important;
    }
    /* ÂøÖË¶Å„Å´Âøú„Åò„Å¶‰ªñ„ÅÆË¶ÅÁ¥†„ÇÇËøΩÂä† */
    </style>
    <!-- ...Êó¢Â≠ò„ÅÆheadÂÜÖ„Ç≥„Éº„Éâ... -->
    <script>
    // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø„Çπ„ÇØ„É™„Éó„ÉàÔºàÊó¢Â≠ò„ÅÆ„ÇÇ„ÅÆ„Åå„Å™„Åë„Çå„Å∞ËøΩÂä†Ôºâ
    function loadTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      const toggle = document.getElementById('theme-toggle');
      if (toggle) toggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      const toggle = document.getElementById('theme-toggle');
      if (toggle) toggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    document.addEventListener('DOMContentLoaded', function() {
      loadTheme();
      const toggle = document.getElementById('theme-toggle');
      if (toggle) toggle.addEventListener('click', toggleTheme);
    });
    </script>
    <!-- ...Êó¢Â≠ò„ÅÆheadÂÜÖ„Ç≥„Éº„Éâ... -->
</head>
<body>
    <header>
        <div class="header-left">
            <button class="hamburger-menu" id="hamburger-menu" type="button">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <img src="assets/logo.png" alt="Shutokun logo" class="logo">
        </div>
        <div class="auth-container">
            <button id="loginBtn" class="auth-button" type="button">Sign in with Google</button>
            <button id="logoutBtn" class="auth-button" style="display: none;" type="button">Sign out</button>
        </div>
    </header>

    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„É°„Éã„É•„Éº -->
<nav class="nav-menu" id="nav-menu">
    <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="how-to-use.html">How To Use</a></li>
    <li><a href="about.html">About Us</a></li>
    <li>
        <button id="clear-cache-btn" style="width:100%;background:none;border:none;color:#c00;cursor:pointer;margin-bottom: 10px;">
            Clear Cache
        </button>
    </li>
    <li>
        <button id="resetAllProgressBtn" style="width:100%;text-align:center;background:none;border:none;color:#c00;cursor:pointer;margin-bottom: 10px;">
            Reset Progress
        </button>
    </li>
    </ul>
</nav>
<!--
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
-->
    <div class="error-message" id="error-message"></div>
    <div class="sync-status" id="sync-status"></div>

    <main class="practice-container">
        <div class="mode-selector">
            <button class="mode-button active" onclick="setMode('hiragana', event)" type="button">Hiragana</button>
            <button class="mode-button" onclick="setMode('katakana', event)" type="button">Katakana</button>
            <button class="mode-button" onclick="setMode('mixed', event)" type="button">Mixed</button>
        </div>

        <div class="practice-settings" style="margin: 1rem 0; display: flex; gap: 1rem; justify-content: center;">
            <div class="setting-group">
                <label>Practice Mode:</label>
                <select id="practice-mode" onchange="updatePracticeSettings()">
                    <option value="reading">Reading (Kana ‚Üí Romaji)</option>
                    <option value="writing">Writing (Romaji ‚Üí Kana)</option>
                    <option value="mixed">Mixed</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Difficulty:</label>
                <select id="difficulty" onchange="updatePracticeSettings()">
                    <option value="basic">Basic</option>
                    <option value="dakuten">With Dakuten</option>
                    <option value="all">All Kana</option>
                </select>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="incorrect-count">0</div>
                <div class="stat-label">Incorrect</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Streak</div>
            </div>
        </div>

        <div class="kana-display" id="kana-display">„ÅÇ</div>

        <div class="input-container">
            <input type="text" id="answer" class="answer-input" placeholder="Type romaji..." autocomplete="off">
            <div class="feedback" id="feedback"></div>
            <div class="keyboard-hints">
                Enter„Ç≠„Éº„ÅßÈÄÅ‰ø°„ÄÅSpace„ÅßÊ¨°„ÅÆ„Åã„Å™<br>
                1-3„Ç≠„Éº„Åß„É¢„Éº„ÉâÂàáÊõøÔºà„Å≤„Çâ„Åå„Å™/„Ç´„Çø„Ç´„Éä/„Éü„ÉÉ„ÇØ„ÇπÔºâ<br>
                R/W/M„Ç≠„Éº„ÅßÁ∑¥Áøí„É¢„Éº„ÉâÂàáÊõøÔºà„É™„Éº„Éá„Ç£„É≥„Ç∞/„É©„Ç§„ÉÜ„Ç£„É≥„Ç∞/„Éü„ÉÉ„ÇØ„ÇπÔºâ
            </div>
        </div>

        <div class="progress-container" style="margin-top: 2rem; display: none;">
            <h3>Progress by Kana</h3>
            <div id="kana-progress" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
        </div>

        <div id="session-summary" class="session-summary" style="display: none; margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Session Summary</h3>
            <div id="summary-content"></div>
            <button onclick="startNewSession()" class="mode-button" style="margin-top: 1rem;">Start New Session</button>
        </div>

        <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div class="navigation-container">
            <button class="nav-button" onclick="window.location.href='index.html'">Back to Home</button>
            <button class="nav-button reset-all-progress" id="resetAllProgressBtn" style="background:#e74c3c;color:white;">Reset All Progress</button>
            <button class="nav-button" onclick="window.location.href='level-select.html'">Change Level</button>
        </div>
    </main>

    <script>
        // „Åã„Å™„Éá„Éº„ÇøÂÆöÁæ©
        const kanaData = {
            hiragana: [
                // Basic vowels
                { kana: '„ÅÇ', romaji: 'a' }, { kana: '„ÅÑ', romaji: 'i' }, { kana: '„ÅÜ', romaji: 'u' },
                { kana: '„Åà', romaji: 'e' }, { kana: '„Åä', romaji: 'o' },
                // K series
                { kana: '„Åã', romaji: 'ka' }, { kana: '„Åç', romaji: 'ki' }, { kana: '„Åè', romaji: 'ku' },
                { kana: '„Åë', romaji: 'ke' }, { kana: '„Åì', romaji: 'ko' },
                // S series
                { kana: '„Åï', romaji: 'sa' }, { kana: '„Åó', romaji: 'shi' }, { kana: '„Åô', romaji: 'su' },
                { kana: '„Åõ', romaji: 'se' }, { kana: '„Åù', romaji: 'so' },
                // T series
                { kana: '„Åü', romaji: 'ta' }, { kana: '„Å°', romaji: 'chi' }, { kana: '„Å§', romaji: 'tsu' },
                { kana: '„Å¶', romaji: 'te' }, { kana: '„Å®', romaji: 'to' },
                // N series
                { kana: '„Å™', romaji: 'na' }, { kana: '„Å´', romaji: 'ni' }, { kana: '„Å¨', romaji: 'nu' },
                { kana: '„Å≠', romaji: 'ne' }, { kana: '„ÅÆ', romaji: 'no' },
                // H series
                { kana: '„ÅØ', romaji: 'ha' }, { kana: '„Å≤', romaji: 'hi' }, { kana: '„Åµ', romaji: 'fu' },
                { kana: '„Å∏', romaji: 'he' }, { kana: '„Åª', romaji: 'ho' },
                // M series
                { kana: '„Åæ', romaji: 'ma' }, { kana: '„Åø', romaji: 'mi' }, { kana: '„ÇÄ', romaji: 'mu' },
                { kana: '„ÇÅ', romaji: 'me' }, { kana: '„ÇÇ', romaji: 'mo' },
                // Y series
                { kana: '„ÇÑ', romaji: 'ya' }, { kana: '„ÇÜ', romaji: 'yu' }, { kana: '„Çà', romaji: 'yo' },
                // R series
                { kana: '„Çâ', romaji: 'ra' }, { kana: '„Çä', romaji: 'ri' }, { kana: '„Çã', romaji: 'ru' },
                { kana: '„Çå', romaji: 're' }, { kana: '„Çç', romaji: 'ro' },
                // W series
                { kana: '„Çè', romaji: 'wa' }, { kana: '„Çí', romaji: 'wo' },
                // N
                { kana: '„Çì', romaji: 'n' },
                // Dakuten
                { kana: '„Åå', romaji: 'ga' }, { kana: '„Åé', romaji: 'gi' }, { kana: '„Åê', romaji: 'gu' },
                { kana: '„Åí', romaji: 'ge' }, { kana: '„Åî', romaji: 'go' },
                { kana: '„Åñ', romaji: 'za' }, { kana: '„Åò', romaji: 'ji' }, { kana: '„Åö', romaji: 'zu' },
                { kana: '„Åú', romaji: 'ze' }, { kana: '„Åû', romaji: 'zo' },
                { kana: '„Å†', romaji: 'da' }, { kana: '„Å¢', romaji: 'ji' }, { kana: '„Å•', romaji: 'zu' },
                { kana: '„Åß', romaji: 'de' }, { kana: '„Å©', romaji: 'do' },
                { kana: '„Å∞', romaji: 'ba' }, { kana: '„Å≥', romaji: 'bi' }, { kana: '„Å∂', romaji: 'bu' },
                { kana: '„Åπ', romaji: 'be' }, { kana: '„Åº', romaji: 'bo' },
                // Handakuten
                { kana: '„Å±', romaji: 'pa' }, { kana: '„Å¥', romaji: 'pi' }, { kana: '„Å∑', romaji: 'pu' },
                { kana: '„Å∫', romaji: 'pe' }, { kana: '„ÅΩ', romaji: 'po' },
                // Small kana
                { kana: '„ÅÅ', romaji: 'a' }, { kana: '„ÅÉ', romaji: 'i' }, { kana: '„ÅÖ', romaji: 'u' },
                { kana: '„Åá', romaji: 'e' }, { kana: '„Åâ', romaji: 'o' },
                { kana: '„Å£', romaji: 'tsu' },
                { kana: '„ÇÉ', romaji: 'ya' }, { kana: '„ÇÖ', romaji: 'yu' }, { kana: '„Çá', romaji: 'yo' }
            ],
            katakana: [
                // Basic vowels
                { kana: '„Ç¢', romaji: 'a' }, { kana: '„Ç§', romaji: 'i' }, { kana: '„Ç¶', romaji: 'u' },
                { kana: '„Ç®', romaji: 'e' }, { kana: '„Ç™', romaji: 'o' },
                // K series
                { kana: '„Ç´', romaji: 'ka' }, { kana: '„Ç≠', romaji: 'ki' }, { kana: '„ÇØ', romaji: 'ku' },
                { kana: '„Ç±', romaji: 'ke' }, { kana: '„Ç≥', romaji: 'ko' },
                // S series
                { kana: '„Çµ', romaji: 'sa' }, { kana: '„Ç∑', romaji: 'shi' }, { kana: '„Çπ', romaji: 'su' },
                { kana: '„Çª', romaji: 'se' }, { kana: '„ÇΩ', romaji: 'so' },
                // T series
                { kana: '„Çø', romaji: 'ta' }, { kana: '„ÉÅ', romaji: 'chi' }, { kana: '„ÉÑ', romaji: 'tsu' },
                { kana: '„ÉÜ', romaji: 'te' }, { kana: '„Éà', romaji: 'to' },
                // N series
                { kana: '„Éä', romaji: 'na' }, { kana: '„Éã', romaji: 'ni' }, { kana: '„Éå', romaji: 'nu' },
                { kana: '„Éç', romaji: 'ne' }, { kana: '„Éé', romaji: 'no' },
                // H series
                { kana: '„Éè', romaji: 'ha' }, { kana: '„Éí', romaji: 'hi' }, { kana: '„Éï', romaji: 'fu' },
                { kana: '„Éò', romaji: 'he' }, { kana: '„Éõ', romaji: 'ho' },
                // M series
                { kana: '„Éû', romaji: 'ma' }, { kana: '„Éü', romaji: 'mi' }, { kana: '„É†', romaji: 'mu' },
                { kana: '„É°', romaji: 'me' }, { kana: '„É¢', romaji: 'mo' },
                // Y series
                { kana: '„É§', romaji: 'ya' }, { kana: '„É¶', romaji: 'yu' }, { kana: '„É®', romaji: 'yo' },
                // R series
                { kana: '„É©', romaji: 'ra' }, { kana: '„É™', romaji: 'ri' }, { kana: '„É´', romaji: 'ru' },
                { kana: '„É¨', romaji: 're' }, { kana: '„É≠', romaji: 'ro' },
                // W series
                { kana: '„ÉØ', romaji: 'wa' }, { kana: '„É≤', romaji: 'wo' },
                // N
                { kana: '„É≥', romaji: 'n' },
                // Dakuten
                { kana: '„Ç¨', romaji: 'ga' }, { kana: '„ÇÆ', romaji: 'gi' }, { kana: '„Ç∞', romaji: 'gu' },
                { kana: '„Ç≤', romaji: 'ge' }, { kana: '„Ç¥', romaji: 'go' },
                { kana: '„Ç∂', romaji: 'za' }, { kana: '„Ç∏', romaji: 'ji' }, { kana: '„Ç∫', romaji: 'zu' },
                { kana: '„Çº', romaji: 'ze' }, { kana: '„Çæ', romaji: 'zo' },
                { kana: '„ÉÄ', romaji: 'da' }, { kana: '„ÉÇ', romaji: 'ji' }, { kana: '„ÉÖ', romaji: 'zu' },
                { kana: '„Éá', romaji: 'de' }, { kana: '„Éâ', romaji: 'do' },
                { kana: '„Éê', romaji: 'ba' }, { kana: '„Éì', romaji: 'bi' }, { kana: '„Éñ', romaji: 'bu' },
                { kana: '„Éô', romaji: 'be' }, { kana: '„Éú', romaji: 'bo' },
                // Handakuten
                { kana: '„Éë', romaji: 'pa' }, { kana: '„Éî', romaji: 'pi' }, { kana: '„Éó', romaji: 'pu' },
                { kana: '„Éö', romaji: 'pe' }, { kana: '„Éù', romaji: 'po' },
                // Small kana
                { kana: '„Ç°', romaji: 'a' }, { kana: '„Ç£', romaji: 'i' }, { kana: '„Ç•', romaji: 'u' },
                { kana: '„Çß', romaji: 'e' }, { kana: '„Ç©', romaji: 'o' },
                { kana: '„ÉÉ', romaji: 'tsu' },
                { kana: '„É£', romaji: 'ya' }, { kana: '„É•', romaji: 'yu' }, { kana: '„Éß', romaji: 'yo' }
            ]
        };

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyB8D99bt_z2FtMeRDY-gdDYFMqqceZV_2s",
            authDomain: "shutokun.firebaseapp.com",
            projectId: "shutokun",
            storageBucket: "shutokun.appspot.com",
            messagingSenderId: "120770573657",
            appId: "1:120770573657:web:692c54b821b0a51c138848",
            measurementId: "G-GJG5NT05DH"
        };

        // FirebaseÂàùÊúüÂåñ
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            firebase.analytics(); // AnalyticsÂàùÊúüÂåñ
        }

        let currentUser = null;
        let currentMode = 'hiragana';
        let currentKana = {};
        let practiceMode = 'reading';
        let difficulty = 'basic';
        let sessionStartTime = Date.now();
        let sessionStats = {
            correct: 0,
            incorrect: 0,
            timeSpent: 0,
            kanaAttempted: new Set()
        };
        let stats = {
            correct: 0,
            incorrect: 0,
            streak: 0,
            get accuracy() {
                const total = this.correct + this.incorrect;
                return total === 0 ? 0 : Math.round((this.correct / total) * 100);
            }
        };

        // Kana progress tracking
        let kanaProgress = {};

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                await loadProgress();
            } else {
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'none';
                // „É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØlocalStorage„Åã„ÇâË™≠„ÅøËæº„Åø
                loadFromLocalStorage();
            }
        });

        // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: debounceÈñ¢Êï∞
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: throttleÈñ¢Êï∞
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func(...args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // „Ç®„É©„ÉºË°®Á§∫„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function showError(message, duration = 5000) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, duration);
        }

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÁÆ°ÁêÜ
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ÂêåÊúüÁä∂ÊÖãÁÆ°ÁêÜ
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('sync-status');
            syncElement.textContent = message;
            syncElement.className = `sync-status ${status}`;
            syncElement.style.display = 'block';
            setTimeout(() => {
                syncElement.style.display = 'none';
            }, 3000);
        }

        // ÈÄ≤Êçó‰øùÂ≠ò„ÅÆÊúÄÈÅ©ÂåñÔºàdebounceÔºâ
        const debouncedSaveProgress = debounce(async () => {
            try {
                updateSyncStatus('syncing', 'Saving progress...');
                await saveProgress();
                updateSyncStatus('synced', 'Progress saved');
            } catch (error) {
                console.error('Error saving progress:', error);
                updateSyncStatus('error', 'Failed to save progress');
                showError('Failed to save progress. Changes will be saved locally.');
            }
        }, 1000);

        // Áµ±Ë®àÊõ¥Êñ∞„ÅÆÊúÄÈÅ©ÂåñÔºàthrottleÔºâ
        const throttledUpdateStats = throttle(() => {
            updateStats();
            updateKanaProgress();
        }, 100);

        // kanaProgress„Çí„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅßÂàùÊúüÂåñ
        function initializeKanaProgress() {
            const allKana = [...kanaData.hiragana, ...kanaData.katakana];
            allKana.forEach(kana => {
                if (!kanaProgress[kana.kana]) {
                    kanaProgress[kana.kana] = { correct: 0, incorrect: 0 };
                }
            });
        }

        // ÈÄ≤ÊçóË™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ„ÇíÂëº„Å≥Âá∫„Åó
        async function loadProgress() {
            if (!currentUser) return;

            showLoading();
            try {
                const progressRef = firebase.database().ref(`users/${currentUser.uid}/kana-progress`);
                const snapshot = await progressRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    kanaProgress = data.progress || {};
                    stats = data.stats || stats;
                    // „Çª„ÉÉ„Ç∑„Éß„É≥Áµ±Ë®à„ÅÆkanaAttempted„ÇÇÂæ©ÂÖÉ
                    if (data.sessionStats && Array.isArray(data.sessionStats.kanaAttempted)) {
                        sessionStats.kanaAttempted = new Set(data.sessionStats.kanaAttempted);
                    }
                }
                initializeKanaProgress();
                throttledUpdateStats();
            } catch (error) {
                console.error("Error loading progress:", error);
                showError('Failed to load progress from server. Using local data.');
                loadFromLocalStorage();
            } finally {
                hideLoading();
            }
        }

        // localStorageÊìç‰Ωú„ÅÆÂº∑ÂåñÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
        function loadFromLocalStorage() {
            try {
                const savedProgress = localStorage.getItem('kanaProgress');
                if (savedProgress) {
                    const data = JSON.parse(savedProgress);
                    kanaProgress = data.progress || {};
                    stats = data.stats || stats;
                    // „Çª„ÉÉ„Ç∑„Éß„É≥Áµ±Ë®à„ÅÆkanaAttempted„ÇÇÂæ©ÂÖÉ
                    if (data.sessionStats && Array.isArray(data.sessionStats.kanaAttempted)) {
                        sessionStats.kanaAttempted = new Set(data.sessionStats.kanaAttempted);
                    }
                    initializeKanaProgress();
                    throttledUpdateStats();
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                showError('Failed to load local progress data.');
            }
        }

        // ÈÄ≤Êçó‰øùÂ≠ò„ÅÆÂº∑ÂåñÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Éª„É™„Éà„É©„Ç§‰ªò„ÅçÔºâ
        async function saveProgress() {
            const data = {
                progress: kanaProgress,
                stats: stats,
                lastModified: Date.now(),
                sessionStats: {
                    ...sessionStats,
                    kanaAttempted: Array.from(sessionStats.kanaAttempted) // Set‚ÜíÈÖçÂàó„Åß‰øùÂ≠ò
                }
            };

            if (currentUser) {
                let retryCount = 0;
                const maxRetries = 3;

                while (retryCount < maxRetries) {
                    try {
                        const progressRef = firebase.database().ref(`users/${currentUser.uid}/kana-progress`);
                        await progressRef.set(data);
                        return;
                    } catch (error) {
                        retryCount++;
                        if (retryCount === maxRetries) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    }
                }
            }

            // Fallback to localStorage
            try {
                localStorage.setItem('kanaProgress', JSON.stringify(data));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showError('Failed to save progress locally.');
            }
        }

        function updateKanaProgress() {
            const container = document.getElementById('kana-progress');
            container.innerHTML = '';

            Object.entries(kanaProgress).forEach(([kana, data]) => {
                const accuracy = data.correct + data.incorrect === 0 ? 0 :
                    Math.round((data.correct / (data.correct + data.incorrect)) * 100);

                const div = document.createElement('div');
                div.className = 'kana-progress-item';
                div.innerHTML = `
                    <div style="font-size: 1.5rem;">${kana}</div>
                    <div style="font-size: 0.9rem; color: #666;">
                        Correct: ${data.correct}<br>
                        Incorrect: ${data.incorrect}<br>
                        Accuracy: ${accuracy}%
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStats() {
            document.getElementById('correct-count').textContent = stats.correct;
            document.getElementById('incorrect-count').textContent = stats.incorrect;
            document.getElementById('accuracy').textContent = `${stats.accuracy}%`;
            document.getElementById('streak').textContent = stats.streak;
        }

        // Èõ£ÊòìÂ∫¶„Éï„Ç£„É´„Çø„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ‰øÆÊ≠£Áâà
        function getFilteredKanaList() {
            let list;
            if (currentMode === 'mixed') {
                const randomMode = Math.random() < 0.5 ? 'hiragana' : 'katakana';
                list = kanaData[randomMode];
            } else {
                list = kanaData[currentMode];
            }

            if (difficulty === 'basic') {
                // Ê∏ÖÈü≥ÔºàÊøÅÁÇπ„ÉªÂçäÊøÅÁÇπ„ÉªÂ∞èÊõ∏„ÅçÊñáÂ≠ó„ÇíÈô§Â§ñÔºâ
                list = list.filter(k => k.kana.match(/^[\u3042-\u3093\u30A2-\u30F3]$/));
            } else if (difficulty === 'dakuten') {
                // ÊøÅÁÇπ„ÉªÂçäÊøÅÁÇπ„ÅÆ„Åø
                list = list.filter(k => k.kana.match(/^[„Åå-„ÅΩ„Ç¨-„Éù„Å±-„ÅΩ„Éë-„Éù]$/));
            }
            // all: „Åô„Åπ„Å¶
            return list;
        }

        // setMode„ÅÆeventÊú™ÂÆöÁæ©ÊôÇ„ÅÆÂá¶ÁêÜ
        function setMode(mode, event) {
            currentMode = mode;
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById('feedback').textContent = '';
            nextKana();
        }

        // nextKana„Åß„É™„Çπ„Éà„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅÆ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        function nextKana() {
            const kanaDisplay = document.getElementById('kana-display');
            kanaDisplay.classList.remove('correct', 'incorrect');
            const list = getFilteredKanaList();
            if (!list || list.length === 0) {
                kanaDisplay.textContent = 'No kana for this setting.';
                document.getElementById('answer').placeholder = '';
                return;
            }
            currentKana = list[Math.floor(Math.random() * list.length)];
            if (practiceMode === 'writing') {
                kanaDisplay.textContent = currentKana.romaji;
                document.getElementById('answer').placeholder = 'Type kana...';
            } else {
                kanaDisplay.textContent = currentKana.kana;
                document.getElementById('answer').placeholder = 'Type romaji...';
            }
            const answerInput = document.getElementById('answer');
            answerInput.value = '';
            answerInput.focus();
        }

        function checkAnswer(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                const input = document.getElementById('answer').value.trim().toLowerCase();
                const feedback = document.getElementById('feedback');
                const kanaDisplay = document.getElementById('kana-display');
                
                try {
                    if (!currentKana || !currentKana.kana || !currentKana.romaji) {
                        throw new Error('Invalid kana data');
                    }

                    // Initialize progress for this kana if not exists
                    if (!kanaProgress[currentKana.kana]) {
                        kanaProgress[currentKana.kana] = { correct: 0, incorrect: 0 };
                    }
                    
                    const isCorrect = practiceMode === 'writing' ? 
                        input === currentKana.kana : 
                        input === currentKana.romaji;
                    
                    if (isCorrect) {
                        feedback.textContent = '‚úÖ Correct!';
                        kanaDisplay.classList.add('correct');
                        stats.correct++;
                        stats.streak++;
                        kanaProgress[currentKana.kana].correct++;
                        sessionStats.correct++;
                    } else {
                        feedback.textContent = `‚ùå Incorrect. The answer was "${practiceMode === 'writing' ? currentKana.kana : currentKana.romaji}"`;
                        kanaDisplay.classList.add('incorrect');
                        stats.incorrect++;
                        stats.streak = 0;
                        kanaProgress[currentKana.kana].incorrect++;
                        sessionStats.incorrect++;
                    }
                    
                    sessionStats.kanaAttempted.add(currentKana.kana);
                    sessionStats.timeSpent = Math.floor((Date.now() - sessionStartTime) / 1000);
                    
                    throttledUpdateStats();
                    debouncedSaveProgress();
                    
                    // Show session summary after 20 attempts or if there's an error
                    if (sessionStats.correct + sessionStats.incorrect >= 20) {
                        showSessionSummary();
                    } else {
                        setTimeout(nextKana, 1000);
                    }
                } catch (error) {
                    console.error('Error processing answer:', error);
                    showError('An error occurred while processing your answer. Please try again.');
                    setTimeout(nextKana, 1000);
                }
            }
        }

        function showSessionSummary() {
            const summary = document.getElementById('session-summary');
            const content = document.getElementById('summary-content');
            
            const accuracy = sessionStats.correct + sessionStats.incorrect === 0 ? 0 :
                Math.round((sessionStats.correct / (sessionStats.correct + sessionStats.incorrect)) * 100);
            
            const minutes = Math.floor(sessionStats.timeSpent / 60);
            const seconds = sessionStats.timeSpent % 60;
            
            content.innerHTML = `
                <p>Total Attempts: ${sessionStats.correct + sessionStats.incorrect}</p>
                <p>Correct: ${sessionStats.correct}</p>
                <p>Incorrect: ${sessionStats.incorrect}</p>
                <p>Accuracy: ${accuracy}%</p>
                <p>Time Spent: ${minutes}m ${seconds}s</p>
                <p>Unique Kana Practiced: ${sessionStats.kanaAttempted.size}</p>
            `;
            
            summary.style.display = 'block';
        }

        // startNewSession„ÅßSet„ÇíÊ≠£„Åó„ÅèÂàùÊúüÂåñ
        function startNewSession() {
            sessionStartTime = Date.now();
            sessionStats = {
                correct: 0,
                incorrect: 0,
                timeSpent: 0,
                kanaAttempted: new Set()
            };
            document.getElementById('session-summary').style.display = 'none';
            nextKana();
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', (event) => {
            if (event.key >= '1' && event.key <= '3') {
                const modes = ['hiragana', 'katakana', 'mixed'];
                setMode(modes[parseInt(event.key) - 1]);
            } else if (event.key.toLowerCase() === 'r') {
                document.getElementById('practice-mode').value = 'reading';
                updatePracticeSettings();
            } else if (event.key.toLowerCase() === 'w') {
                document.getElementById('practice-mode').value = 'writing';
                updatePracticeSettings();
            } else if (event.key.toLowerCase() === 'm') {
                document.getElementById('practice-mode').value = 'mixed';
                updatePracticeSettings();
            }
        });

        // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('online', () => {
            updateSyncStatus('syncing', 'Back online, syncing...');
            debouncedSaveProgress();
        });

        window.addEventListener('offline', () => {
            updateSyncStatus('error', 'Offline mode - changes saved locally');
        });

        // „Ç¢„Éó„É™ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
    try {
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÊ©üËÉΩ
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const navMenu = document.getElementById('nav-menu');
        let menuOverlay;

        if (hamburgerMenu && navMenu) {
            // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë¶ÅÁ¥†‰ΩúÊàê
            menuOverlay = document.createElement('div');
            menuOverlay.className = 'menu-overlay';
            document.body.appendChild(menuOverlay);

            // „É°„Éã„É•„Éº„ÅÆ„Éà„Ç∞„É´Èñ¢Êï∞
            function toggleMenu() {
                hamburgerMenu.classList.toggle('active');
                navMenu.classList.toggle('active');
                menuOverlay.classList.toggle('active');
                document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
            }

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            hamburgerMenu.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);

            // „É°„Éã„É•„ÉºÂÜÖ„É™„É≥„ÇØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            const navLinks = navMenu.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (navMenu.classList.contains('active')) {
                        toggleMenu();
                    }
                });
            });
        }
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
                document.getElementById('answer').addEventListener('keyup', checkAnswer);
                // „Ç¢„Éó„É™ÂàùÊúüÂåñ
                setMode('hiragana');
                // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
                if (navigator.onLine) {
                    updateSyncStatus('synced', 'Online');
                } else {
                    updateSyncStatus('error', 'Offline mode');
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Failed to initialize the app. Please refresh the page.');
            }
        });

        // ÂÖ®ÈÄ≤Êçó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
        const resetAllBtn = document.getElementById('resetAllProgressBtn');
        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', () => {
                if (confirm('Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆ„Åã„Å™ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                    // localStorage„Å®FirebaseÔºàÂà©Áî®ÊôÇÔºâ„ÅÆÂÖ®„Åã„Å™ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà
                    localStorage.removeItem('kanaProgress');
                    // Firebase‰øùÂ≠ò„Åå„ÅÇ„Çå„Å∞„Åì„Åì„ÅßÂâäÈô§Âá¶ÁêÜ„ÇíËøΩÂä†
                    // ÁîªÈù¢„É™„É≠„Éº„Éâ„ÅßÂàùÊúüÁä∂ÊÖã„Å´
                    location.reload();
                }
            });
        }
    </script>
    <script src="/firebase-db.js"></script>
    <script src="/script.js"></script>
</body>
</html>
