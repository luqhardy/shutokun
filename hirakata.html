<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kana Practice - Shutokun</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .practice-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            text-align: center;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mode-button {
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .mode-button:hover {
            background-color: #45a049;
        }

        .mode-button.active {
            background-color: #357abd;
        }

        .kana-display {
            font-size: 120px;
            margin: 2rem 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .kana-display.correct {
            transform: scale(1.1);
            color: #4CAF50;
        }

        .kana-display.incorrect {
            transform: scale(0.9);
            color: #f44336;
        }

        .input-container {
            margin: 2rem 0;
        }

        .answer-input {
            font-size: 1.5rem;
            padding: 1rem;
            width: 200px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .feedback {
            font-size: 1.2rem;
            margin: 1rem 0;
            min-height: 2rem;
            transition: opacity 0.3s;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .keyboard-hints {
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 600px) {
            .kana-display {
                font-size: 80px;
            }

            .answer-input {
                width: 150px;
                font-size: 1.2rem;
            }

            .stats-container {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Loading and Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            display: none;
        }

        .sync-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
        }

        .sync-status.syncing {
            background: #fff3e0;
            color: #ef6c00;
        }

        .sync-status.synced {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sync-status.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <button class="hamburger-menu" id="hamburger-menu" type="button">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <img src="assets/logo.png" alt="Shutokun logo" class="logo">
        </div>
        <div class="auth-container">
            <button id="loginBtn" class="auth-button" type="button">Sign in with Google</button>
            <button id="logoutBtn" class="auth-button" style="display: none;" type="button">Sign out</button>
        </div>
    </header>

    <nav class="nav-menu" id="nav-menu">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="how-to-use.html">How To Use</a></li>
            <li><a href="about.html">About Us</a></li>
        </ul>
    </nav>
<!--
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
-->
    <div class="error-message" id="error-message"></div>
    <div class="sync-status" id="sync-status"></div>

    <main class="practice-container">
        <div class="mode-selector">
            <button class="mode-button active" onclick="setMode('hiragana', event)" type="button">Hiragana</button>
            <button class="mode-button" onclick="setMode('katakana', event)" type="button">Katakana</button>
            <button class="mode-button" onclick="setMode('mixed', event)" type="button">Mixed</button>
        </div>

        <div class="practice-settings" style="margin: 1rem 0; display: flex; gap: 1rem; justify-content: center;">
            <div class="setting-group">
                <label>Practice Mode:</label>
                <select id="practice-mode" onchange="updatePracticeSettings()">
                    <option value="reading">Reading (Kana → Romaji)</option>
                    <option value="writing">Writing (Romaji → Kana)</option>
                    <option value="mixed">Mixed</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Difficulty:</label>
                <select id="difficulty" onchange="updatePracticeSettings()">
                    <option value="basic">Basic</option>
                    <option value="dakuten">With Dakuten</option>
                    <option value="all">All Kana</option>
                </select>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="incorrect-count">0</div>
                <div class="stat-label">Incorrect</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Streak</div>
            </div>
        </div>

        <div class="kana-display" id="kana-display">あ</div>

        <div class="input-container">
            <input type="text" id="answer" class="answer-input" placeholder="Type romaji..." autocomplete="off">
            <div class="feedback" id="feedback"></div>
            <div class="keyboard-hints">
                Press Enter to submit, Space for next kana<br>
                Press 1-3 to switch modes (Hiragana/Katakana/Mixed)<br>
                Press R/W/M to switch practice mode (Reading/Writing/Mixed)
            </div>
        </div>

        <div class="progress-container" style="margin-top: 2rem; display: none;">
            <h3>Progress by Kana</h3>
            <div id="kana-progress" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
        </div>

        <div id="session-summary" class="session-summary" style="display: none; margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Session Summary</h3>
            <div id="summary-content"></div>
            <button onclick="startNewSession()" class="mode-button" style="margin-top: 1rem;">Start New Session</button>
        </div>
    </main>

    <script>
        const kanaData = {
            hiragana: [
                // Basic vowels
                { kana: 'あ', romaji: 'a' }, { kana: 'い', romaji: 'i' }, { kana: 'う', romaji: 'u' },
                { kana: 'え', romaji: 'e' }, { kana: 'お', romaji: 'o' },
                // K series
                { kana: 'か', romaji: 'ka' }, { kana: 'き', romaji: 'ki' }, { kana: 'く', romaji: 'ku' },
                { kana: 'け', romaji: 'ke' }, { kana: 'こ', romaji: 'ko' },
                // S series
                { kana: 'さ', romaji: 'sa' }, { kana: 'し', romaji: 'shi' }, { kana: 'す', romaji: 'su' },
                { kana: 'せ', romaji: 'se' }, { kana: 'そ', romaji: 'so' },
                // T series
                { kana: 'た', romaji: 'ta' }, { kana: 'ち', romaji: 'chi' }, { kana: 'つ', romaji: 'tsu' },
                { kana: 'て', romaji: 'te' }, { kana: 'と', romaji: 'to' },
                // N series
                { kana: 'な', romaji: 'na' }, { kana: 'に', romaji: 'ni' }, { kana: 'ぬ', romaji: 'nu' },
                { kana: 'ね', romaji: 'ne' }, { kana: 'の', romaji: 'no' },
                // H series
                { kana: 'は', romaji: 'ha' }, { kana: 'ひ', romaji: 'hi' }, { kana: 'ふ', romaji: 'fu' },
                { kana: 'へ', romaji: 'he' }, { kana: 'ほ', romaji: 'ho' },
                // M series
                { kana: 'ま', romaji: 'ma' }, { kana: 'み', romaji: 'mi' }, { kana: 'む', romaji: 'mu' },
                { kana: 'め', romaji: 'me' }, { kana: 'も', romaji: 'mo' },
                // Y series
                { kana: 'や', romaji: 'ya' }, { kana: 'ゆ', romaji: 'yu' }, { kana: 'よ', romaji: 'yo' },
                // R series
                { kana: 'ら', romaji: 'ra' }, { kana: 'り', romaji: 'ri' }, { kana: 'る', romaji: 'ru' },
                { kana: 'れ', romaji: 're' }, { kana: 'ろ', romaji: 'ro' },
                // W series
                { kana: 'わ', romaji: 'wa' }, { kana: 'を', romaji: 'wo' },
                // N
                { kana: 'ん', romaji: 'n' },
                // Dakuten
                { kana: 'が', romaji: 'ga' }, { kana: 'ぎ', romaji: 'gi' }, { kana: 'ぐ', romaji: 'gu' },
                { kana: 'げ', romaji: 'ge' }, { kana: 'ご', romaji: 'go' },
                { kana: 'ざ', romaji: 'za' }, { kana: 'じ', romaji: 'ji' }, { kana: 'ず', romaji: 'zu' },
                { kana: 'ぜ', romaji: 'ze' }, { kana: 'ぞ', romaji: 'zo' },
                { kana: 'だ', romaji: 'da' }, { kana: 'ぢ', romaji: 'ji' }, { kana: 'づ', romaji: 'zu' },
                { kana: 'で', romaji: 'de' }, { kana: 'ど', romaji: 'do' },
                { kana: 'ば', romaji: 'ba' }, { kana: 'び', romaji: 'bi' }, { kana: 'ぶ', romaji: 'bu' },
                { kana: 'べ', romaji: 'be' }, { kana: 'ぼ', romaji: 'bo' },
                // Handakuten
                { kana: 'ぱ', romaji: 'pa' }, { kana: 'ぴ', romaji: 'pi' }, { kana: 'ぷ', romaji: 'pu' },
                { kana: 'ぺ', romaji: 'pe' }, { kana: 'ぽ', romaji: 'po' },
                // Small kana
                { kana: 'ぁ', romaji: 'a' }, { kana: 'ぃ', romaji: 'i' }, { kana: 'ぅ', romaji: 'u' },
                { kana: 'ぇ', romaji: 'e' }, { kana: 'ぉ', romaji: 'o' },
                { kana: 'っ', romaji: 'tsu' },
                { kana: 'ゃ', romaji: 'ya' }, { kana: 'ゅ', romaji: 'yu' }, { kana: 'ょ', romaji: 'yo' }
            ],
            katakana: [
                // Basic vowels
                { kana: 'ア', romaji: 'a' }, { kana: 'イ', romaji: 'i' }, { kana: 'ウ', romaji: 'u' },
                { kana: 'エ', romaji: 'e' }, { kana: 'オ', romaji: 'o' },
                // K series
                { kana: 'カ', romaji: 'ka' }, { kana: 'キ', romaji: 'ki' }, { kana: 'ク', romaji: 'ku' },
                { kana: 'ケ', romaji: 'ke' }, { kana: 'コ', romaji: 'ko' },
                // S series
                { kana: 'サ', romaji: 'sa' }, { kana: 'シ', romaji: 'shi' }, { kana: 'ス', romaji: 'su' },
                { kana: 'セ', romaji: 'se' }, { kana: 'ソ', romaji: 'so' },
                // T series
                { kana: 'タ', romaji: 'ta' }, { kana: 'チ', romaji: 'chi' }, { kana: 'ツ', romaji: 'tsu' },
                { kana: 'テ', romaji: 'te' }, { kana: 'ト', romaji: 'to' },
                // N series
                { kana: 'ナ', romaji: 'na' }, { kana: 'ニ', romaji: 'ni' }, { kana: 'ヌ', romaji: 'nu' },
                { kana: 'ネ', romaji: 'ne' }, { kana: 'ノ', romaji: 'no' },
                // H series
                { kana: 'ハ', romaji: 'ha' }, { kana: 'ヒ', romaji: 'hi' }, { kana: 'フ', romaji: 'fu' },
                { kana: 'ヘ', romaji: 'he' }, { kana: 'ホ', romaji: 'ho' },
                // M series
                { kana: 'マ', romaji: 'ma' }, { kana: 'ミ', romaji: 'mi' }, { kana: 'ム', romaji: 'mu' },
                { kana: 'メ', romaji: 'me' }, { kana: 'モ', romaji: 'mo' },
                // Y series
                { kana: 'ヤ', romaji: 'ya' }, { kana: 'ユ', romaji: 'yu' }, { kana: 'ヨ', romaji: 'yo' },
                // R series
                { kana: 'ラ', romaji: 'ra' }, { kana: 'リ', romaji: 'ri' }, { kana: 'ル', romaji: 'ru' },
                { kana: 'レ', romaji: 're' }, { kana: 'ロ', romaji: 'ro' },
                // W series
                { kana: 'ワ', romaji: 'wa' }, { kana: 'ヲ', romaji: 'wo' },
                // N
                { kana: 'ン', romaji: 'n' },
                // Dakuten
                { kana: 'ガ', romaji: 'ga' }, { kana: 'ギ', romaji: 'gi' }, { kana: 'グ', romaji: 'gu' },
                { kana: 'ゲ', romaji: 'ge' }, { kana: 'ゴ', romaji: 'go' },
                { kana: 'ザ', romaji: 'za' }, { kana: 'ジ', romaji: 'ji' }, { kana: 'ズ', romaji: 'zu' },
                { kana: 'ゼ', romaji: 'ze' }, { kana: 'ゾ', romaji: 'zo' },
                { kana: 'ダ', romaji: 'da' }, { kana: 'ヂ', romaji: 'ji' }, { kana: 'ヅ', romaji: 'zu' },
                { kana: 'デ', romaji: 'de' }, { kana: 'ド', romaji: 'do' },
                { kana: 'バ', romaji: 'ba' }, { kana: 'ビ', romaji: 'bi' }, { kana: 'ブ', romaji: 'bu' },
                { kana: 'ベ', romaji: 'be' }, { kana: 'ボ', romaji: 'bo' },
                // Handakuten
                { kana: 'パ', romaji: 'pa' }, { kana: 'ピ', romaji: 'pi' }, { kana: 'プ', romaji: 'pu' },
                { kana: 'ペ', romaji: 'pe' }, { kana: 'ポ', romaji: 'po' },
                // Small kana
                { kana: 'ァ', romaji: 'a' }, { kana: 'ィ', romaji: 'i' }, { kana: 'ゥ', romaji: 'u' },
                { kana: 'ェ', romaji: 'e' }, { kana: 'ォ', romaji: 'o' },
                { kana: 'ッ', romaji: 'tsu' },
                { kana: 'ャ', romaji: 'ya' }, { kana: 'ュ', romaji: 'yu' }, { kana: 'ョ', romaji: 'yo' }
            ]
        };

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8D99bt_z2FtMeRDY-gdDYFMqqceZV_2s",
            authDomain: "shutokun.firebaseapp.com",
            projectId: "shutokun",
            storageBucket: "shutokun.appspot.com",
            messagingSenderId: "120770573657",
            appId: "1:120770573657:web:692c54b821b0a51c138848",
            measurementId: "G-GJG5NT05DH"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            firebase.analytics(); // Analytics初期化
        }

        let currentUser = null;
        let currentMode = 'hiragana';
        let currentKana = {};
        let practiceMode = 'reading';
        let difficulty = 'basic';
        let sessionStartTime = Date.now();
        let sessionStats = {
            correct: 0,
            incorrect: 0,
            timeSpent: 0,
            kanaAttempted: new Set()
        };
        let stats = {
            correct: 0,
            incorrect: 0,
            streak: 0,
            get accuracy() {
                const total = this.correct + this.incorrect;
                return total === 0 ? 0 : Math.round((this.correct / total) * 100);
            }
        };

        // Kana progress tracking
        let kanaProgress = {};

        // Auth state observer
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                await loadProgress();
            } else {
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'none';
                // Load from localStorage if not logged in
                loadFromLocalStorage();
            }
        });

        // Performance optimization: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Performance optimization: Throttle function
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func(...args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // Error handling utility
        function showError(message, duration = 5000) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, duration);
        }

        // Loading state management
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // Sync status management
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('sync-status');
            syncElement.textContent = message;
            syncElement.className = `sync-status ${status}`;
            syncElement.style.display = 'block';
            setTimeout(() => {
                syncElement.style.display = 'none';
            }, 3000);
        }

        // Optimized progress saving with debounce
        const debouncedSaveProgress = debounce(async () => {
            try {
                updateSyncStatus('syncing', 'Saving progress...');
                await saveProgress();
                updateSyncStatus('synced', 'Progress saved');
            } catch (error) {
                console.error('Error saving progress:', error);
                updateSyncStatus('error', 'Failed to save progress');
                showError('Failed to save progress. Changes will be saved locally.');
            }
        }, 1000);

        // Optimized stats update with throttle
        const throttledUpdateStats = throttle(() => {
            updateStats();
            updateKanaProgress();
        }, 100);

        // Initialize kanaProgress with default values
        function initializeKanaProgress() {
            const allKana = [...kanaData.hiragana, ...kanaData.katakana];
            allKana.forEach(kana => {
                if (!kanaProgress[kana.kana]) {
                    kanaProgress[kana.kana] = { correct: 0, incorrect: 0 };
                }
            });
        }

        // Call initialization when loading progress
        async function loadProgress() {
            if (!currentUser) return;

            showLoading();
            try {
                const progressRef = firebase.database().ref(`users/${currentUser.uid}/kana-progress`);
                const snapshot = await progressRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    kanaProgress = data.progress || {};
                    stats = data.stats || stats;
                    // セッション統計のkanaAttemptedも復元
                    if (data.sessionStats && Array.isArray(data.sessionStats.kanaAttempted)) {
                        sessionStats.kanaAttempted = new Set(data.sessionStats.kanaAttempted);
                    }
                }
                initializeKanaProgress();
                throttledUpdateStats();
            } catch (error) {
                console.error("Error loading progress:", error);
                showError('Failed to load progress from server. Using local data.');
                loadFromLocalStorage();
            } finally {
                hideLoading();
            }
        }

        // Enhanced localStorage operations with error handling
        function loadFromLocalStorage() {
            try {
                const savedProgress = localStorage.getItem('kanaProgress');
                if (savedProgress) {
                    const data = JSON.parse(savedProgress);
                    kanaProgress = data.progress || {};
                    stats = data.stats || stats;
                    // セッション統計のkanaAttemptedも復元
                    if (data.sessionStats && Array.isArray(data.sessionStats.kanaAttempted)) {
                        sessionStats.kanaAttempted = new Set(data.sessionStats.kanaAttempted);
                    }
                    initializeKanaProgress();
                    throttledUpdateStats();
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                showError('Failed to load local progress data.');
            }
        }

        // Enhanced save progress with error handling and retry logic
        async function saveProgress() {
            const data = {
                progress: kanaProgress,
                stats: stats,
                lastModified: Date.now(),
                sessionStats: {
                    ...sessionStats,
                    kanaAttempted: Array.from(sessionStats.kanaAttempted) // Set→配列で保存
                }
            };

            if (currentUser) {
                let retryCount = 0;
                const maxRetries = 3;

                while (retryCount < maxRetries) {
                    try {
                        const progressRef = firebase.database().ref(`users/${currentUser.uid}/kana-progress`);
                        await progressRef.set(data);
                        return;
                    } catch (error) {
                        retryCount++;
                        if (retryCount === maxRetries) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    }
                }
            }

            // Fallback to localStorage
            try {
                localStorage.setItem('kanaProgress', JSON.stringify(data));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showError('Failed to save progress locally.');
            }
        }

        function updateKanaProgress() {
            const container = document.getElementById('kana-progress');
            container.innerHTML = '';

            Object.entries(kanaProgress).forEach(([kana, data]) => {
                const accuracy = data.correct + data.incorrect === 0 ? 0 :
                    Math.round((data.correct / (data.correct + data.incorrect)) * 100);

                const div = document.createElement('div');
                div.className = 'kana-progress-item';
                div.innerHTML = `
                    <div style="font-size: 1.5rem;">${kana}</div>
                    <div style="font-size: 0.9rem; color: #666;">
                        Correct: ${data.correct}<br>
                        Incorrect: ${data.incorrect}<br>
                        Accuracy: ${accuracy}%
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStats() {
            document.getElementById('correct-count').textContent = stats.correct;
            document.getElementById('incorrect-count').textContent = stats.incorrect;
            document.getElementById('accuracy').textContent = `${stats.accuracy}%`;
            document.getElementById('streak').textContent = stats.streak;
        }

        // 難易度フィルタのロジック修正版
        function getFilteredKanaList() {
            let list;
            if (currentMode === 'mixed') {
                const randomMode = Math.random() < 0.5 ? 'hiragana' : 'katakana';
                list = kanaData[randomMode];
            } else {
                list = kanaData[currentMode];
            }

            if (difficulty === 'basic') {
                // 清音（濁点・半濁点・小書き文字を除外）
                list = list.filter(k => k.kana.match(/^[\u3042-\u3093\u30A2-\u30F3]$/));
            } else if (difficulty === 'dakuten') {
                // 濁点・半濁点のみ
                list = list.filter(k => k.kana.match(/^[が-ぽガ-ポぱ-ぽパ-ポ]$/));
            }
            // all: すべて
            return list;
        }

        // setModeのevent未定義時の処理
        function setMode(mode, event) {
            currentMode = mode;
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById('feedback').textContent = '';
            nextKana();
        }

        // nextKanaでリストが空の場合のエラーハンドリング
        function nextKana() {
            const kanaDisplay = document.getElementById('kana-display');
            kanaDisplay.classList.remove('correct', 'incorrect');
            const list = getFilteredKanaList();
            if (!list || list.length === 0) {
                kanaDisplay.textContent = 'No kana for this setting.';
                document.getElementById('answer').placeholder = '';
                return;
            }
            currentKana = list[Math.floor(Math.random() * list.length)];
            if (practiceMode === 'writing') {
                kanaDisplay.textContent = currentKana.romaji;
                document.getElementById('answer').placeholder = 'Type kana...';
            } else {
                kanaDisplay.textContent = currentKana.kana;
                document.getElementById('answer').placeholder = 'Type romaji...';
            }
            const answerInput = document.getElementById('answer');
            answerInput.value = '';
            answerInput.focus();
        }

        function checkAnswer(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                const input = document.getElementById('answer').value.trim().toLowerCase();
                const feedback = document.getElementById('feedback');
                const kanaDisplay = document.getElementById('kana-display');
                
                try {
                    if (!currentKana || !currentKana.kana || !currentKana.romaji) {
                        throw new Error('Invalid kana data');
                    }

                    // Initialize progress for this kana if not exists
                    if (!kanaProgress[currentKana.kana]) {
                        kanaProgress[currentKana.kana] = { correct: 0, incorrect: 0 };
                    }
                    
                    const isCorrect = practiceMode === 'writing' ? 
                        input === currentKana.kana : 
                        input === currentKana.romaji;
                    
                    if (isCorrect) {
                        feedback.textContent = '✅ Correct!';
                        kanaDisplay.classList.add('correct');
                        stats.correct++;
                        stats.streak++;
                        kanaProgress[currentKana.kana].correct++;
                        sessionStats.correct++;
                    } else {
                        feedback.textContent = `❌ Incorrect. The answer was "${practiceMode === 'writing' ? currentKana.kana : currentKana.romaji}"`;
                        kanaDisplay.classList.add('incorrect');
                        stats.incorrect++;
                        stats.streak = 0;
                        kanaProgress[currentKana.kana].incorrect++;
                        sessionStats.incorrect++;
                    }
                    
                    sessionStats.kanaAttempted.add(currentKana.kana);
                    sessionStats.timeSpent = Math.floor((Date.now() - sessionStartTime) / 1000);
                    
                    throttledUpdateStats();
                    debouncedSaveProgress();
                    
                    // Show session summary after 20 attempts or if there's an error
                    if (sessionStats.correct + sessionStats.incorrect >= 20) {
                        showSessionSummary();
                    } else {
                        setTimeout(nextKana, 1000);
                    }
                } catch (error) {
                    console.error('Error processing answer:', error);
                    showError('An error occurred while processing your answer. Please try again.');
                    setTimeout(nextKana, 1000);
                }
            }
        }

        function showSessionSummary() {
            const summary = document.getElementById('session-summary');
            const content = document.getElementById('summary-content');
            
            const accuracy = sessionStats.correct + sessionStats.incorrect === 0 ? 0 :
                Math.round((sessionStats.correct / (sessionStats.correct + sessionStats.incorrect)) * 100);
            
            const minutes = Math.floor(sessionStats.timeSpent / 60);
            const seconds = sessionStats.timeSpent % 60;
            
            content.innerHTML = `
                <p>Total Attempts: ${sessionStats.correct + sessionStats.incorrect}</p>
                <p>Correct: ${sessionStats.correct}</p>
                <p>Incorrect: ${sessionStats.incorrect}</p>
                <p>Accuracy: ${accuracy}%</p>
                <p>Time Spent: ${minutes}m ${seconds}s</p>
                <p>Unique Kana Practiced: ${sessionStats.kanaAttempted.size}</p>
            `;
            
            summary.style.display = 'block';
        }

        // startNewSessionでSetを正しく初期化
        function startNewSession() {
            sessionStartTime = Date.now();
            sessionStats = {
                correct: 0,
                incorrect: 0,
                timeSpent: 0,
                kanaAttempted: new Set()
            };
            document.getElementById('session-summary').style.display = 'none';
            nextKana();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.key >= '1' && event.key <= '3') {
                const modes = ['hiragana', 'katakana', 'mixed'];
                setMode(modes[parseInt(event.key) - 1]);
            } else if (event.key.toLowerCase() === 'r') {
                document.getElementById('practice-mode').value = 'reading';
                updatePracticeSettings();
            } else if (event.key.toLowerCase() === 'w') {
                document.getElementById('practice-mode').value = 'writing';
                updatePracticeSettings();
            } else if (event.key.toLowerCase() === 'm') {
                document.getElementById('practice-mode').value = 'mixed';
                updatePracticeSettings();
            }
        });

        // Network status handling
        window.addEventListener('online', () => {
            updateSyncStatus('syncing', 'Back online, syncing...');
            debouncedSaveProgress();
        });

        window.addEventListener('offline', () => {
            updateSyncStatus('error', 'Offline mode - changes saved locally');
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Set up event listeners
                document.getElementById('answer').addEventListener('keyup', checkAnswer);
                
                // Initialize the app
                setMode('hiragana');
                
                // Set up network status indicator
                if (navigator.onLine) {
                    updateSyncStatus('synced', 'Online');
                } else {
                    updateSyncStatus('error', 'Offline mode');
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Failed to initialize the app. Please refresh the page.');
            }
        });
    </script>
    <script src="firebase-db.js"></script>
    <script src="script.js"></script>
</body>
</html>
